# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  # Below is the definition of your job to build and test your app, you can rename and customize it as you want.
  build-and-test:
    # These next lines define a Docker executor: https://circleci.com/docs/2.0/executor-types/
    # You can specify an image from Dockerhub or use one of our Convenience Images from CircleCI's Developer Hub.
    # Be sure to update the Docker image tag below to openjdk version of your application.
    # A list of available CircleCI Docker Convenience Images are available here: https://circleci.com/developer/images/image/cimg/openjdk
    docker:
      - image: maven:3.8-openjdk-8
    # Add steps to the job
    # See: https://circleci.com/docs/2.0/configuration-reference/#steps
    steps:
      # Checkout the code as the first step.
      - checkout
      # Use mvn clean and package as the standard maven build phase
      # Then run your tests!
      - run:
          name: Test
          command: mvn -Dtest=io.openmessaging.rocketmq.consumer.LocalMessageCacheTest,io.openmessaging.rocketmq.producer.ProducerImplTest,org.apache.rocketmq.acl.common.AclClientRPCHookTest,org.apache.rocketmq.acl.common.PermissionTest,org.apache.rocketmq.acl.plain.PlainAccessControlFlowTest,org.apache.rocketmq.acl.plain.RemoteAddressStrategyTest,org.apache.rocketmq.broker.client.ProducerManagerTest,org.apache.rocketmq.broker.filter.CommitLogDispatcherCalcBitMapTest,org.apache.rocketmq.broker.filtersrv.FilterServerManagerTest,org.apache.rocketmq.broker.offset.ConsumerOffsetManagerTest,org.apache.rocketmq.broker.pagecache.OneMessageTransferTest,org.apache.rocketmq.broker.processor.ChangeInvisibleTimeProcessorTest,org.apache.rocketmq.broker.processor.EndTransactionProcessorTest,org.apache.rocketmq.broker.processor.PopReviveServiceTest,org.apache.rocketmq.broker.processor.ReplyMessageProcessorTest,org.apache.rocketmq.broker.substription.ForbiddenTest,org.apache.rocketmq.broker.transaction.queue.DefaultTransactionalMessageCheckListenerTest,org.apache.rocketmq.broker.util.LogTransactionalMessageCheckListener,org.apache.rocketmq.broker.BrokerControllerTest,org.apache.rocketmq.broker.BrokerStartupTest,org.apache.rocketmq.client.consumer.rebalance.AllocateMessageQueueAveragelyByCircleTest,org.apache.rocketmq.client.consumer.rebalance.AllocateMessageQueueByMachineRoomTest,org.apache.rocketmq.client.consumer.store.RemoteBrokerOffsetStoreTest,org.apache.rocketmq.client.consumer.DefaultMQPushConsumerTest,org.apache.rocketmq.client.impl.consumer.DefaultMQPushConsumerImplTest,org.apache.rocketmq.client.impl.consumer.RebalancePushImplTest,org.apache.rocketmq.client.latency.LatencyFaultToleranceImplTest,org.apache.rocketmq.client.producer.DefaultMQProducerTest,org.apache.rocketmq.client.trace.DefaultMQConsumerWithTraceTest,org.apache.rocketmq.client.trace.DefaultMQProducerWithTraceTest,org.apache.rocketmq.client.trace.TransactionMQProducerWithOpenTracingTest,org.apache.rocketmq.client.ValidatorsTest,org.apache.rocketmq.common.attribute.AttributeTest,org.apache.rocketmq.common.message.MessageClientIDSetterTest,org.apache.rocketmq.common.protocol.body.BrokerStatsDataTest,org.apache.rocketmq.common.protocol.body.ConsumeStatsListTest,org.apache.rocketmq.common.protocol.body.KVTableTest,org.apache.rocketmq.common.protocol.body.QueryCorrectionOffsetBodyTest,org.apache.rocketmq.common.protocol.header.FastCodesHeaderTest,org.apache.rocketmq.common.protocol.topic.OffsetMovedEventTest,org.apache.rocketmq.common.protocol.GroupListTest,org.apache.rocketmq.common.statictopic.TopicQueueMappingTest,org.apache.rocketmq.common.subscription.CustomizedRetryPolicyTest,org.apache.rocketmq.common.sysflag.CompressionFlagTest,org.apache.rocketmq.common.utils.CheckpointFileTest,org.apache.rocketmq.common.utils.NameServerAddressUtilsTest,org.apache.rocketmq.common.CountDownLatch2Test,org.apache.rocketmq.common.MessageBatchTest,org.apache.rocketmq.common.RegisterBrokerBodyTest,org.apache.rocketmq.common.TopicConfigTest,org.apache.rocketmq.container.BrokerContainerTest,org.apache.rocketmq.controller.impl.controller.impl.DLedgerControllerTest,org.apache.rocketmq.filter.BitsArrayTest,org.apache.rocketmq.filter.FilterSpiTest,org.apache.rocketmq.logging.inner.LayoutTest,org.apache.rocketmq.logging.inner.LoggerTest,org.apache.rocketmq.logging.BasicLoggerTest,org.apache.rocketmq.logging.Slf4jLoggerFactoryTest,org.apache.rocketmq.namesrv.processor.ClusterTestRequestProcessorTest,org.apache.rocketmq.namesrv.routeinfo.GetRouteInfoBenchmark,org.apache.rocketmq.namesrv.routeinfo.RouteInfoManagerBrokerRegisterTest,org.apache.rocketmq.namesrv.routeinfo.RouteInfoManagerTestBase,org.apache.rocketmq.namesrv.NamesrvControllerTest,org.apache.rocketmq.proxy.common.ReceiptHandleGroupTest,org.apache.rocketmq.proxy.config.MetricCollectorModeTest,org.apache.rocketmq.proxy.grpc.v2.common.GrpcConverterTest,org.apache.rocketmq.proxy.grpc.v2.consumer.ReceiveMessageActivityTest,org.apache.rocketmq.proxy.grpc.v2.producer.SendMessageActivityTest,org.apache.rocketmq.proxy.grpc.v2.AbstractMessingActivityTest,org.apache.rocketmq.proxy.processor.BaseProcessorTest,org.apache.rocketmq.proxy.processor.ReceiptHandleProcessorTest,org.apache.rocketmq.proxy.service.message.LocalMessageServiceTest,org.apache.rocketmq.proxy.service.mqclient.ProxyClientRemotingProcessorTest,org.apache.rocketmq.proxy.service.route.ClusterTopicRouteServiceTest,org.apache.rocketmq.proxy.service.transaction.AbstractTransactionServiceTest,org.apache.rocketmq.proxy.service.BaseServiceTest,org.apache.rocketmq.remoting.netty.NettyClientConfigTest,org.apache.rocketmq.remoting.netty.NettyServerConfigTest,org.apache.rocketmq.remoting.protocol.RemotingCommandTest,org.apache.rocketmq.remoting.protocol.RocketMQSerializableTest,org.apache.rocketmq.remoting.TlsTest,org.apache.rocketmq.store.dledger.DLedgerMultiPathTest,org.apache.rocketmq.store.ha.autoswitch.AutoSwitchHATest,org.apache.rocketmq.store.ha.HAClientTest,org.apache.rocketmq.store.index.IndexFileTest,org.apache.rocketmq.store.queue.ConsumeQueueStoreTest,org.apache.rocketmq.store.stats.BrokerStatsManagerTest,org.apache.rocketmq.store.timer.TimerLogTest,org.apache.rocketmq.store.timer.TimerWheelTest,org.apache.rocketmq.store.ConsumeQueueExtTest,org.apache.rocketmq.store.DefaultMessageStoreShutDownTest,org.apache.rocketmq.store.HATest,org.apache.rocketmq.store.MultiDispatchTest,org.apache.rocketmq.store.StoreStatsServiceTest,org.apache.rocketmq.test.autoswitchrole.AutoSwitchRoleBase,org.apache.rocketmq.test.base.BaseConf,org.apache.rocketmq.test.client.consumer.balance.NormalMsgStaticBalanceIT,org.apache.rocketmq.test.client.consumer.broadcast.normal.BroadcastNormalMsgRecvFailIT,org.apache.rocketmq.test.client.consumer.broadcast.normal.NormalMsgTwoSameGroupConsumerIT,org.apache.rocketmq.test.client.consumer.broadcast.tag.BroadcastTwoConsumerSubDiffTagIT,org.apache.rocketmq.test.client.consumer.cluster.DynamicAddAndCrashIT,org.apache.rocketmq.test.client.consumer.filter.SqlFilterIT,org.apache.rocketmq.test.client.consumer.tag.TagMessageWith1ConsumerIT,org.apache.rocketmq.test.client.consumer.topic.MulConsumerMulTopicIT,org.apache.rocketmq.test.client.producer.async.AsyncSendWithMessageQueueIT,org.apache.rocketmq.test.client.producer.batch.BatchSendIT,org.apache.rocketmq.test.client.producer.exception.msg.MessageUserPropIT,org.apache.rocketmq.test.client.producer.oneway.OneWaySendIT,org.apache.rocketmq.test.client.producer.order.OrderMsgDynamicRebalanceIT,org.apache.rocketmq.test.client.producer.order.OrderMsgWithTagIT,org.apache.rocketmq.test.client.producer.querymsg.QueryMsgByKeyIT,org.apache.rocketmq.test.container.BrokerFailoverIT,org.apache.rocketmq.test.container.GetMaxOffsetFromSlaveIT,org.apache.rocketmq.test.container.PullMultipleReplicasIT,org.apache.rocketmq.test.container.ScheduleSlaveActingMasterIT,org.apache.rocketmq.test.container.SlaveBrokerIT,org.apache.rocketmq.test.delay.NormalMsgDelayIT,org.apache.rocketmq.test.grpc.v2.LocalGrpcIT,org.apache.rocketmq.test.schema.SchemaTest,org.apache.rocketmq.test.tls.TlsIT,org.apache.rocketmq.tools.admin.DefaultMQAdminExtTest,org.apache.rocketmq.tools.command.acl.GetAccessConfigSubCommandTest,org.apache.rocketmq.tools.command.broker.BrokerConsumeStatsSubCommadTest,org.apache.rocketmq.tools.command.broker.CleanUnusedTopicCommandTest,org.apache.rocketmq.tools.command.broker.SendMsgStatusCommandTest,org.apache.rocketmq.tools.command.connection.ProducerConnectionSubCommandTest,org.apache.rocketmq.tools.command.consumer.GetConsumerConfigSubCommandTest,org.apache.rocketmq.tools.command.message.QueryMsgTraceByIdSubCommandTest,org.apache.rocketmq.tools.command.namesrv.GetNamesrvConfigCommandTest,org.apache.rocketmq.tools.command.offset.GetConsumerStatusCommandTest,org.apache.rocketmq.tools.command.offset.SkipAccumulationCommandTest,org.apache.rocketmq.tools.command.server.ServerResponseMocker,org.apache.rocketmq.tools.command.topic.TopicClusterSubCommandTest,org.apache.rocketmq.tools.command.topic.UpdateOrderConfCommandTest,org.apache.rocketmq.tools.command.CommandUtilTest  test -Dmaven.test.failure.ignore=true -DfailIfNoTests=false
 
      - store_test_results:
         path: "**/*.xml"

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  sample: # This is the name of the workflow, feel free to change it to better match your workflow.
    # Inside the workflow, you define the jobs you want to run.
    jobs:
      - build-and-test
